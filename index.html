<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ª–∏—Å—Ç–æ–≤–æ–∫</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
        }
        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .error button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .error button:hover {
            background: #b71c1c;
        }
        .iframe-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –ª–∏—Å—Ç–æ–≤–æ–∫...</h3>
            <p id="status">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</p>
        </div>
        <div id="error" class="error hidden"></div>
    </div>

    <div id="iframeContainer" class="iframe-container hidden">
        <iframe id="calculatorFrame" allow="camera; microphone; fullscreen"></iframe>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function setStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = message;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(title, details = '') {
            document.getElementById('loading').style.display = 'none';
            const errorEl = document.getElementById('error');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `
                <h3>‚ùå ${title}</h3>
                <p>${details}</p>
                <button onclick="location.reload()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                <p style="margin-top: 20px; font-size: 12px; color: #999;">
                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤
                </p>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –Ω–∞–ø—Ä—è–º—É—é
        function loadCalculatorDirect(dealId) {
            setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –Ω–∞–ø—Ä—è–º—É—é...');
            
            const iframeContainer = document.getElementById('iframeContainer');
            const iframe = document.getElementById('calculatorFrame');
            const mainContainer = document.getElementById('mainContainer');
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL
            let url = `https://publicfork.vercel.app/?deal_id=${dealId}`;
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ —á–µ—Ä–µ–∑ URL (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ)
            const urlParams = new URLSearchParams(window.location.search);
            const dealTitle = urlParams.get('deal_title');
            if (dealTitle) {
                url += `&deal_title=${encodeURIComponent(dealTitle)}`;
            }
            
            console.log('Loading calculator directly:', url);
            
            iframe.src = url;
            mainContainer.classList.add('hidden');
            iframeContainer.classList.remove('hidden');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ iframe –ë–∏—Ç—Ä–∏–∫—Å24
        function isInBitrixIframe() {
            try {
                return window.self !== window.top && 
                       document.referrer.includes('bitrix24');
            } catch (e) {
                return true; // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –º—ã –≤ iframe
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        async function init() {
            try {
                setStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è...');
                
                // –ü–æ–ª—É—á–∞–µ–º deal_id –∏–∑ URL
                const urlParams = new URLSearchParams(window.location.search);
                const dealId = urlParams.get('deal_id');
                
                if (!dealId) {
                    showError('ID —Å–¥–µ–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω', '–ü–∞—Ä–∞–º–µ—Ç—Ä deal_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ URL');
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –ë–∏—Ç—Ä–∏–∫—Å24
                if (!isInBitrixIframe()) {
                    console.log('Not in Bitrix24 iframe, loading directly');
                    loadCalculatorDirect(dealId);
                    return;
                }

                setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –ë–∏—Ç—Ä–∏–∫—Å24 API...');

                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å BX24 —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
                let bx24Loaded = false;

                // –°–ø–æ—Å–æ–± 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://api.bitrix24.com/api/v1/';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                        
                        // –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥
                        setTimeout(() => reject(new Error('Timeout')), 5000);
                    });
                    
                    if (typeof BX24 !== 'undefined') {
                        bx24Loaded = true;
                        console.log('BX24 loaded via standard script');
                    }
                } catch (e) {
                    console.log('Standard script failed:', e);
                }

                // –ï—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL
                if (!bx24Loaded) {
                    try {
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = 'https://cdn.bitrix24.com/api/v1/';
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                            
                            setTimeout(() => reject(new Error('Timeout')), 5000);
                        });
                        
                        if (typeof BX24 !== 'undefined') {
                            bx24Loaded = true;
                            console.log('BX24 loaded via alternative URL');
                        }
                    } catch (e) {
                        console.log('Alternative script failed:', e);
                    }
                }

                // –ï—Å–ª–∏ BX24 –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
                if (!bx24Loaded || typeof BX24 === 'undefined') {
                    console.log('BX24 not available, using direct access');
                    loadCalculatorDirect(dealId);
                    return;
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º BX24
                setStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–∏—Ç—Ä–∏–∫—Å24...');
                
                BX24.init(function() {
                    try {
                        setStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–µ...');
                        
                        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å ID –∏–∑ placement
                        let currentDealId = dealId;
                        
                        try {
                            const placementInfo = BX24.placement.info();
                            if (placementInfo && placementInfo.options && placementInfo.options.ID) {
                                currentDealId = placementInfo.options.ID;
                            }
                        } catch (e) {
                            console.log('Could not get placement info, using URL param');
                        }

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
                        loadCalculatorDirect(currentDealId);
                        
                    } catch (e) {
                        console.error('BX24 init error:', e);
                        loadCalculatorDirect(dealId);
                    }
                });

            } catch (e) {
                console.error('Fatal error:', e);
                
                // –í —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
                const urlParams = new URLSearchParams(window.location.search);
                const dealId = urlParams.get('deal_id');
                
                if (dealId) {
                    loadCalculatorDirect(dealId);
                } else {
                    showError('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', e.message);
                }
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
